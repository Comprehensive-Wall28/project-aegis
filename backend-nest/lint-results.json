[{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/dto/share.dto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/public-share.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/public-share.service.ts","messages":[{"ruleId":"@typescript-eslint/no-redundant-type-constituents","severity":2,"message":"'any' overrides all other types in this union type.","line":71,"column":46,"nodeType":"TSAnyKeyword","messageId":"overrides","endLine":71,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":130,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":130,"endColumn":15}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n  Injectable,\n  BadRequestException,\n  NotFoundException,\n  InternalServerErrorException,\n  Logger,\n} from '@nestjs/common';\nimport { SharedLinkRepository } from './repositories/shared-link.repository';\nimport { VaultRepository } from '../vault/vault.repository';\nimport { FolderRepository } from '../folders/folders.repository';\nimport { UsersRepository } from '../users/users.repository';\nimport { GoogleDriveService } from '../vault/google-drive.service';\nimport { AuditService } from '../../common/services/audit.service';\nimport { Readable } from 'stream';\nimport { FastifyRequest } from 'fastify';\nimport { Types } from 'mongoose';\n\nexport interface LinkMetadata {\n  metadata: {\n    type: 'file' | 'folder';\n    name: string;\n    size?: number;\n    mimeType?: string;\n    createdAt: Date;\n    id: string;\n    ownerName: string;\n  };\n  encryptedKey: string;\n  isPublic: boolean;\n  requiresAuth: boolean;\n}\n\nexport interface FileDownloadResponse {\n  stream: Readable;\n  mimeType: string;\n  fileName: string;\n  fileSize: number;\n}\n\n@Injectable()\nexport class PublicShareService {\n  private readonly logger = new Logger(PublicShareService.name);\n\n  constructor(\n    private readonly sharedLinkRepository: SharedLinkRepository,\n    private readonly vaultRepository: VaultRepository,\n    private readonly folderRepository: FolderRepository,\n    private readonly usersRepository: UsersRepository,\n    private readonly googleDriveService: GoogleDriveService,\n    private readonly auditService: AuditService,\n  ) {}\n\n  async getLinkMetadata(\n    token: string,\n    req?: FastifyRequest,\n  ): Promise<LinkMetadata> {\n    if (!token) {\n      throw new BadRequestException('Token is required');\n    }\n\n    const link = await this.sharedLinkRepository.findByToken(token);\n    if (!link) {\n      throw new NotFoundException('Link not found or expired');\n    }\n\n    await this.sharedLinkRepository.incrementViewCount(\n      (link._id as unknown as Types.ObjectId).toString(),\n    );\n\n    let ownerName = 'Aegis User';\n    let metadata: LinkMetadata['metadata'] | any = {};\n\n    if (link.resourceType === 'file') {\n      const file = await this.vaultRepository.findById(\n        (link.resourceId as unknown as Types.ObjectId).toString(),\n      );\n      if (!file) {\n        throw new NotFoundException('File not found');\n      }\n\n      if (file.ownerId) {\n        const owner = await this.usersRepository.findById(\n          (file.ownerId as unknown as Types.ObjectId).toString(),\n        );\n        if (owner) ownerName = owner.username;\n      }\n\n      metadata = {\n        type: 'file',\n        name: file.originalFileName,\n        size: file.fileSize,\n        mimeType: file.mimeType,\n        createdAt: file.createdAt,\n        id: (file._id as unknown as Types.ObjectId).toString(),\n        ownerName,\n      };\n    } else {\n      const folder = await this.folderRepository.findById(\n        (link.resourceId as unknown as Types.ObjectId).toString(),\n      );\n      if (!folder) {\n        throw new NotFoundException('Folder not found');\n      }\n\n      if (folder.ownerId) {\n        const owner = await this.usersRepository.findById(\n          (folder.ownerId as unknown as Types.ObjectId).toString(),\n        );\n        if (owner) ownerName = owner.username;\n      }\n\n      metadata = {\n        type: 'folder',\n        name: folder.name,\n        createdAt: folder.createdAt,\n        id: (folder._id as unknown as Types.ObjectId).toString(),\n        ownerName,\n      };\n    }\n\n    await this.auditService.logAuditEvent(\n      (link.creatorId as unknown as Types.ObjectId).toString(),\n      'READER_VIEW_ACCESS',\n      'SUCCESS',\n      req,\n      { token, resourceId: link.resourceId },\n    );\n\n    return {\n      metadata,\n      encryptedKey: link.encryptedKey,\n      isPublic: link.isPublic,\n      requiresAuth: !link.isPublic,\n    };\n  }\n\n  async downloadSharedFile(\n    token: string,\n    req?: FastifyRequest,\n  ): Promise<FileDownloadResponse> {\n    if (!token) {\n      throw new BadRequestException('Token is required');\n    }\n\n    const link = await this.sharedLinkRepository.findByToken(token);\n    if (!link) {\n      throw new NotFoundException('Link not found');\n    }\n\n    if (link.resourceType !== 'file') {\n      throw new BadRequestException('Not a file link');\n    }\n\n    const fileRecord = await this.vaultRepository.findById(\n      (link.resourceId as unknown as Types.ObjectId).toString(),\n    );\n    if (!fileRecord || !fileRecord.googleDriveFileId) {\n      throw new NotFoundException('File not found');\n    }\n\n    // TODO: strict auth check for restricted links if needed\n    // Assuming current implementation allows public download if link is valid\n    // But logic says requiresAuth if !isPublic.\n    // If !isPublic, we should probably check if user is authenticated/authorized.\n    // Legacy code didn't implementation auth check in downloadSharedFile explicitly, just comment.\n\n    try {\n      const stream = await this.googleDriveService.getFileStream(\n        fileRecord.googleDriveFileId,\n      );\n      const creatorIdStr = (\n        link.creatorId as unknown as Types.ObjectId\n      ).toString();\n\n      await this.auditService.logAuditEvent(\n        creatorIdStr,\n        'FILE_SHARE', // reusing FILE_SHARE or create a new one like FILE_DOWNLOAD_SHARED\n        'SUCCESS',\n        req,\n        {\n          token,\n          fileId: (fileRecord._id as unknown as Types.ObjectId).toString(),\n        },\n      );\n\n      return {\n        stream,\n        mimeType: fileRecord.mimeType || 'application/octet-stream',\n        fileName: fileRecord.originalFileName,\n        fileSize: fileRecord.fileSize,\n      };\n    } catch (error) {\n      this.logger.error('Shared file download error', error);\n      throw new InternalServerErrorException('Download failed');\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/repositories/shared-file.repository.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `_QueryFilter<{ fileId: VaultFile; sharedBy: User; sharedWith: User; encryptedSharedKey: string; permissions: string[]; _id: ObjectId; $assertPopulated: <Paths = {}>(path: string | string[], values?: Partial<...> | undefined) => Omit<...> & Paths; ... 253 more ...; \"schema.virtualpath\": (name: string) => VirtualType<...`.","line":21,"column":16,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":24,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Model, Types } from 'mongoose';\nimport { SharedFile, SharedFileDocument } from '../schemas/shared-file.schema';\nimport { BaseRepository } from '../../../common/repositories/base.repository';\n\n@Injectable()\nexport class SharedFileRepository extends BaseRepository<SharedFileDocument> {\n  constructor(\n    @InjectModel(SharedFile.name)\n    private readonly sharedFileModel: Model<SharedFileDocument>,\n  ) {\n    super(sharedFileModel);\n  }\n\n  async findByFileAndUser(\n    fileId: string,\n    userId: string,\n  ): Promise<SharedFileDocument | null> {\n    return this.sharedFileModel\n      .findOne({\n        fileId: new Types.ObjectId(fileId),\n        sharedWith: new Types.ObjectId(userId),\n      } as any)\n      .exec();\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/repositories/shared-link.repository.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":21,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":21,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `_QueryFilter<{ token: string; resourceType: string; resourceId: ObjectId; encryptedKey: string; isPublic: boolean; _id: ObjectId; $assertPopulated: <Paths = {}>(path: string | string[], values?: Partial<...> | undefined) => Omit<...> & Paths; ... 258 more ...; \"creatorId.currentChallenge\": string | undefined; }> | u...`.","line":24,"column":33,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":24,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `_QueryFilter<{ token: string; resourceType: string; resourceId: ObjectId; encryptedKey: string; isPublic: boolean; _id: ObjectId; $assertPopulated: <Paths = {}>(path: string | string[], values?: Partial<...> | undefined) => Omit<...> & Paths; ... 258 more ...; \"creatorId.currentChallenge\": string | undefined; }> | u...`.","line":25,"column":43,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":25,"endColumn":48}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Model, Types } from 'mongoose';\nimport { SharedLink, SharedLinkDocument } from '../schemas/shared-link.schema';\nimport { BaseRepository } from '../../../common/repositories/base.repository';\n\n@Injectable()\nexport class SharedLinkRepository extends BaseRepository<SharedLinkDocument> {\n  constructor(\n    @InjectModel(SharedLink.name)\n    private readonly sharedLinkModel: Model<SharedLinkDocument>,\n  ) {\n    super(sharedLinkModel);\n  }\n\n  async findLinksByCreator(\n    userId: string,\n    skip: number,\n    limit: number,\n  ): Promise<{ links: SharedLinkDocument[]; total: number }> {\n    const query = { creatorId: new Types.ObjectId(userId) } as any;\n\n    const [links, total] = await Promise.all([\n      this.sharedLinkModel.find(query).skip(skip).limit(limit).exec(),\n      this.sharedLinkModel.countDocuments(query).exec(),\n    ]);\n\n    return { links, total };\n  }\n\n  async findByToken(token: string): Promise<SharedLinkDocument | null> {\n    return this.sharedLinkModel.findOne({ token }).exec();\n  }\n\n  async incrementViewCount(id: string): Promise<void> {\n    await this.sharedLinkModel\n      .updateOne({ _id: new Types.ObjectId(id) }, { $inc: { views: 1 } })\n      .exec();\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/schemas/shared-file.schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/schemas/shared-link.schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/share.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/share.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/var/home/comprehensive-wall28/codium/aegis/backend-nest/src/modules/share/share.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
